# AccessToFiles

Управление доступом к приватным файлам.

#### Установка

``
composer reqire avtomon/accesstofiles
``

#### Как это работает

Предположим, нам нужно дать доступ к файлу <b>document.pdf</b> на <b>1 час</b> и к файлу <b>picture.jpg</b> на 5 минут авторизованному в данный момент пользователю. Причем эти файлы по умолчанию недоступны этому пользователю.

Для начала выполним следующий код:

```
// Первый файл
AccessToFiles::getInstance(3600)->addFiles(['document.pdf']);

// Второй файл
AccessToFiles::getInstance(300)->addFiles(['picture.jpg']);
```

В этой части мы создаем два объекта <i>AccessToFiles</i> - один для открытия доступа на 1 час - второй на открытие доступа на 5 минут. И затем добавляем по файлу в каждый объект.

Интсанс класса <i>AccessToFiles</i> всегда создается один на промежуток времени доступа, это значит что если мы после кода выше выполним:

```
$af = AccessToFiles::getInstance(3600);
```

то новый объект создан не будет, а лишь вернется уже созданный выше объект для файлов доступных 1 час.

Чтобы открыть доступ к файлам для кажгого инстанса необходимо выполнить метод <i>allowFiles</i>:

```
AccessToFiles::getInstance(3600)->allowFiles();
AccessToFiles::getInstance(300)->allowFiles();
```

этот метод записывает метаданные о файлах (что за файлы, на какой срок, кому...) в хранилище метаданных, по умолчанию это Redis.

Теперь, если этот же пользователь обратится к этим файлам, то они будут ему доступны, но по истечению отмеренных промежутком времени (1 час и 5 минут соответственно) <del>карета снова правратится в тыкву</del> файлы снова будут недоступны.

За отдачу временно открытых файлов отвечает lua-скрипт для nginx, который умеет лазить в Redis b проверять есть ли там данных для запрашиваемого файла, если есть - отдает файл.

Как lua-скрипт определяет пользвателя?

При записи метаданных о файле <i>AccessToFiles</i> использует приём <b>Finger print</b> - пытается собарть о текущем пользователе столько данных, чтобы его (пользователя) нельзя было ни с кем спутать.

По умолчанию для этого используется только идентифкатор сессии, но могут использоваться и HTTP-заголовки на случай кражи сессии.

<b>Примечание:</b> lua-скрипт хранящийся в проекте будет работь только с набором идентификационных данных по умолчанию, т. е. если используется только идентификатор сессии, чтобы расширить набор необходимы будут небольшие доработки.


<br>

[Документация](docs_ru)
